name: Deploy Atlas

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-atlas-production-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: production
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Validate required secrets
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_HOST_FINGERPRINT: ${{ secrets.DEPLOY_HOST_FINGERPRINT }}
        run: |
          set -Eeuo pipefail
          required_vars=(
            DEPLOY_HOST
            DEPLOY_PORT
            DEPLOY_USER
            DEPLOY_SSH_KEY
            DEPLOY_PATH
            DEPLOY_HOST_FINGERPRINT
          )
          for var_name in "${required_vars[@]}"; do
            if [ -z "${!var_name:-}" ]; then
              echo "::error title=Missing secret::${var_name} is required."
              exit 1
            fi
          done

      - name: Configure SSH with pinned host fingerprint
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_HOST_FINGERPRINT: ${{ secrets.DEPLOY_HOST_FINGERPRINT }}
        run: |
          set -Eeuo pipefail
          install -m 700 -d ~/.ssh
          printf '%s\n' "$DEPLOY_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          ssh-keyscan -T 15 -p "$DEPLOY_PORT" "$DEPLOY_HOST" > ~/.ssh/known_hosts.tmp

          if ! ssh-keygen -l -E sha256 -f ~/.ssh/known_hosts.tmp | awk '{print $2}' | grep -Fxq "$DEPLOY_HOST_FINGERPRINT"; then
            echo "::error title=Host fingerprint mismatch::Expected fingerprint not found for $DEPLOY_HOST:$DEPLOY_PORT."
            echo "Expected: $DEPLOY_HOST_FINGERPRINT"
            echo "Observed:"
            ssh-keygen -l -E sha256 -f ~/.ssh/known_hosts.tmp | awk '{print $2}'
            exit 1
          fi

          mv ~/.ssh/known_hosts.tmp ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy over SSH
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_BRANCH: ${{ github.ref_name }}
        run: |
          set -Eeuo pipefail
          case "$DEPLOY_BRANCH" in
            main) ;;
            *)
              echo "::error::Refusing deploy from unexpected branch: $DEPLOY_BRANCH"
              exit 1
              ;;
          esac

          ssh \
            -i ~/.ssh/id_ed25519 \
            -p "$DEPLOY_PORT" \
            -o BatchMode=yes \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=yes \
            "$DEPLOY_USER@$DEPLOY_HOST" \
            bash -se -- "$DEPLOY_PATH" "$DEPLOY_BRANCH" <<'REMOTE_SCRIPT'
          set -Eeuo pipefail
          IFS=$'\n\t'

          DEPLOY_PATH="$1"
          DEPLOY_BRANCH="$2"

          cd "$DEPLOY_PATH"
          git fetch origin "$DEPLOY_BRANCH" --prune --tags
          git checkout -B "$DEPLOY_BRANCH" "origin/$DEPLOY_BRANCH"
          git reset --hard "origin/$DEPLOY_BRANCH"

          docker compose up -d --build --remove-orphans
          docker compose ps

          docker compose exec -T atlas_app python -m compileall atlas_app
          docker compose exec -T atlas_app curl \
            -fsS \
            --retry 8 \
            --retry-connrefused \
            --retry-delay 2 \
            http://localhost:5000/health >/dev/null
          REMOTE_SCRIPT

      - name: Clean up SSH key material
        if: always()
        run: |
          set -Eeuo pipefail
          rm -f ~/.ssh/id_ed25519 ~/.ssh/known_hosts ~/.ssh/known_hosts.tmp
